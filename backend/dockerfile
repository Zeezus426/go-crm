# Production Dockerfile for Go-CRM Django Backend
FROM python:3.12-slim

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    DJANGO_SETTINGS_MODULE=core.settings.prod \
    PYTHONPATH=/app

COPY --from=ghcr.io/astral-sh/uv:latest /uv /bin/uv

RUN apt-get update \
  && apt-get install -y build-essential libpq-dev gettext curl \
  && apt-get purge -y --auto-remove -o APT::AutoRemove::RecommendsImportant=false \
  && rm -rf /var/lib/apt/lists/*

RUN addgroup --system django && adduser --system --ingroup django django

RUN uv venv /opt/venv

ENV PATH="/opt/venv/bin:$PATH"

# Copy requirements.txt from current directory (backend)
COPY requirements.txt /tmp/requirements.txt

# Install Python dependencies
RUN uv pip install -r /tmp/requirements.txt && rm /tmp/requirements.txt

# Create necessary directories
RUN mkdir -p /app/logs /app/staticfiles /app/mediafiles

# Copy current directory (backend) to /app
COPY --chown=django:django . /app

# Change working directory to /app where manage.py is located
WORKDIR /app

# Collect static files (now running from /app)
RUN python manage.py collectstatic --noinput --settings=core.settings.prod

HEALTHCHECK --interval=30s --timeout=10s --retries=3 \
  CMD curl -f http://localhost:8000/health/ || exit 1

USER django

EXPOSE 8000

# Start Daphne ASGI server (running from /app directory)
CMD ["daphne", "-b", "0.0.0.0", "-p", "8000", "core.asgi:application"]